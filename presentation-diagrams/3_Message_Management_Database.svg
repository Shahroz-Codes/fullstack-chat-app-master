<svg viewBox="0 0 1200 950" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" style="max-width: 1200px; max-height: 950px; overflow: auto;">
  <defs>
    <marker id="arrowRed" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#ff6b6b" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="600" y="40" font-size="32" font-weight="bold" text-anchor="middle" fill="#1a365d">Feature 3: Message Management &amp; Database Architecture</text>

  <!-- Legend -->
  <rect x="50" y="70" width="1100" height="50" fill="#f0f4f8" stroke="#cbd5e0" stroke-width="2" rx="5"/>
  <text x="70" y="105" font-size="12" fill="#2d3748">Message Schema → CRUD Operations → Image Upload → Message Retrieval &amp; History</text>

  <!-- DATABASE SCHEMA Section -->
  <text x="60" y="160" font-size="18" font-weight="bold" fill="#1a365d">MongoDB Schema</text>

  <!-- User Model -->
  <rect x="60" y="180" width="280" height="220" fill="#fff5e6" stroke="#ff9c3d" stroke-width="3" rx="8"/>
  <text x="200" y="210" font-size="14" font-weight="bold" text-anchor="middle" fill="#ad4e04">User Model</text>
  <text x="70" y="240" font-size="11" fill="#5c2e0f" font-family="monospace">collection: "users"</text>

  <rect x="80" y="260" width="240" height="130" fill="#fffacd" stroke="#daa520" stroke-width="1" rx="4"/>
  <text x="90" y="280" font-size="10" fill="#333" font-family="monospace">{</text>
  <text x="105" y="300" font-size="10" fill="#333" font-family="monospace">_id: ObjectId,</text>
  <text x="105" y="320" font-size="10" fill="#333" font-family="monospace">fullName: String,</text>
  <text x="105" y="340" font-size="10" fill="#333" font-family="monospace">email: String(unique),</text>
  <text x="105" y="360" font-size="10" fill="#333" font-family="monospace">password: String(hashed),</text>
  <text x="105" y="380" font-size="10" fill="#333" font-family="monospace">profilePic: String(URL),</text>
  <text x="105" y="400" font-size="10" fill="#333" font-family="monospace">createdAt: Timestamp</text>
  <text x="90" y="420" font-size="10" fill="#333" font-family="monospace">}</text>

  <!-- Message Model -->
  <rect x="460" y="180" width="280" height="220" fill="#e0f7ff" stroke="#13c2c2" stroke-width="3" rx="8"/>
  <text x="600" y="210" font-size="14" font-weight="bold" text-anchor="middle" fill="#003f5c">Message Model</text>
  <text x="470" y="240" font-size="11" fill="#0a3f3f" font-family="monospace">collection: "messages"</text>

  <rect x="480" y="260" width="240" height="130" fill="#b5f5ea" stroke="#13c2c2" stroke-width="1" rx="4"/>
  <text x="490" y="280" font-size="10" fill="#333" font-family="monospace">{</text>
  <text x="505" y="300" font-size="10" fill="#333" font-family="monospace">_id: ObjectId,</text>
  <text x="505" y="320" font-size="10" fill="#333" font-family="monospace">senderId: ObjectId,</text>
  <text x="505" y="340" font-size="10" fill="#333" font-family="monospace">receiverId: ObjectId,</text>
  <text x="505" y="360" font-size="10" fill="#333" font-family="monospace">text: String,</text>
  <text x="505" y="380" font-size="10" fill="#333" font-family="monospace">image: String(URL),</text>
  <text x="505" y="400" font-size="10" fill="#333" font-family="monospace">createdAt: Timestamp</text>
  <text x="490" y="420" font-size="10" fill="#333" font-family="monospace">}</text>

  <!-- Relationships -->
  <line x1="340" y1="290" x2="460" y2="290" stroke="#ff6b6b" stroke-width="2" marker-end="url(#arrowRed)"/>
  <text x="395" y="280" font-size="11" fill="#c92a2a" font-weight="bold">references</text>

  <line x1="340" y1="310" x2="460" y2="310" stroke="#ff6b6b" stroke-width="2" marker-end="url(#arrowRed)"/>
  <text x="390" y="330" font-size="11" fill="#c92a2a" font-weight="bold">references</text>

  <!-- CRUD OPERATIONS Section -->
  <text x="60" y="460" font-size="18" font-weight="bold" fill="#1a365d">Message Operations</text>

  <!-- Send Message -->
  <rect x="60" y="480" width="260" height="180" fill="#fff0f6" stroke="#c2185b" stroke-width="2" rx="8"/>
  <text x="190" y="510" font-size="13" font-weight="bold" text-anchor="middle" fill="#880e4f">POST /send/:receiverId</text>

  <rect x="80" y="530" width="220" height="120" fill="#f8bbd0" stroke="#c2185b" stroke-width="1" rx="4"/>
  <text x="90" y="550" font-size="10" fill="#333" font-family="monospace">1. Receive text &amp; image</text>
  <text x="90" y="570" font-size="10" fill="#333" font-family="monospace">2. If image: Upload to</text>
  <text x="110" y="585" font-size="10" fill="#333" font-family="monospace">Cloudinary → get URL</text>
  <text x="90" y="605" font-size="10" fill="#333" font-family="monospace">3. Create Message doc</text>
  <text x="90" y="625" font-size="10" fill="#333" font-family="monospace">4. Emit via Socket.io</text>

  <!-- Get Messages -->
  <rect x="470" y="480" width="260" height="180" fill="#e0f2f1" stroke="#00695c" stroke-width="2" rx="8"/>
  <text x="600" y="510" font-size="13" font-weight="bold" text-anchor="middle" fill="#004d40">GET /messages/:userId</text>

  <rect x="490" y="530" width="220" height="120" fill="#80cbc4" stroke="#00695c" stroke-width="1" rx="4"/>
  <text x="500" y="550" font-size="10" fill="#333" font-family="monospace">1. Extract my userId</text>
  <text x="500" y="570" font-size="10" fill="#333" font-family="monospace">2. Query MongoDB with:</text>
  <text x="520" y="585" font-size="9" fill="#333" font-family="monospace">Find where (sender=me</text>
  <text x="520" y="600" font-size="9" fill="#333" font-family="monospace">AND receiver=them) OR</text>
  <text x="520" y="615" font-size="9" fill="#333" font-family="monospace">(sender=them AND ...</text>
  <text x="500" y="630" font-size="10" fill="#333" font-family="monospace">3. Return sorted messages</text>

  <!-- Get Users List -->
  <rect x="880" y="480" width="260" height="180" fill="#f3e5f5" stroke="#6a1b9a" stroke-width="2" rx="8"/>
  <text x="1010" y="510" font-size="13" font-weight="bold" text-anchor="middle" fill="#4a148c">GET /messages/users</text>

  <rect x="900" y="530" width="220" height="120" fill="#ce93d8" stroke="#6a1b9a" stroke-width="1" rx="4"/>
  <text x="910" y="550" font-size="10" fill="#333" font-family="monospace">1. Get my userId from JWT</text>
  <text x="910" y="570" font-size="10" fill="#333" font-family="monospace">2. Query all users EXCEPT</text>
  <text x="930" y="585" font-size="10" fill="#333" font-family="monospace">me from User collection</text>
  <text x="910" y="605" font-size="10" fill="#333" font-family="monospace">3. Exclude password field</text>
  <text x="910" y="625" font-size="10" fill="#333" font-family="monospace">4. Return filtered list</text>

  <!-- IMAGE UPLOAD FLOW Section -->
  <text x="60" y="750" font-size="18" font-weight="bold" fill="#1a365d">Image Upload Flow (Cloudinary)</text>

  <!-- Image Upload Box -->
  <rect x="60" y="770" width="1100" height="140" fill="#fffacd" stroke="#daa520" stroke-width="2" rx="8"/>

  <circle cx="100" cy="810" r="15" fill="#ff6b6b" stroke="#c92a2a" stroke-width="2"/>
  <text x="100" y="817" font-size="11" font-weight="bold" text-anchor="middle" fill="white">1</text>
  <text x="130" y="820" font-size="11" fill="#333">User selects image → Converted to Base64 in frontend</text>

  <circle cx="620" cy="810" r="15" fill="#4ecdc4" stroke="#0a9396" stroke-width="2"/>
  <text x="620" y="817" font-size="11" font-weight="bold" text-anchor="middle" fill="white">3</text>
  <text x="650" y="820" font-size="11" fill="#333">Backend: cloudinary.uploader.upload(base64String)</text>

  <circle cx="620" cy="850" r="15" fill="#4ecdc4" stroke="#0a9396" stroke-width="2"/>
  <text x="620" y="857" font-size="11" font-weight="bold" text-anchor="middle" fill="white">4</text>
  <text x="650" y="860" font-size="11" fill="#333">Cloudinary returns secure_url (HTTPS link)</text>

  <circle cx="1050" cy="810" r="15" fill="#a8e6cf" stroke="#56ab2f" stroke-width="2"/>
  <text x="1050" y="817" font-size="11" font-weight="bold" text-anchor="middle" fill="white">5</text>
  <text x="1080" y="820" font-size="11" fill="#333">Save URL in MongoDB Message doc</text>

  <circle cx="1050" cy="850" r="15" fill="#a8e6cf" stroke="#56ab2f" stroke-width="2"/>
  <text x="1050" y="857" font-size="11" font-weight="bold" text-anchor="middle" fill="white">6</text>
  <text x="1080" y="860" font-size="11" fill="#333">Frontend displays image via URL</text>

  <circle cx="100" cy="850" r="15" fill="#ff6b6b" stroke="#c92a2a" stroke-width="2"/>
  <text x="100" y="857" font-size="11" font-weight="bold" text-anchor="middle" fill="white">2</text>
  <text x="130" y="860" font-size="11" fill="#333">Base64 sent in request body to POST /send/:id</text>
</svg>
